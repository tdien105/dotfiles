.POSIX:
.PHONY: default build switch update clean check help

# Default target - build and apply
default: switch

# Help information
help:
	@echo "macOS Nix Configuration - Available targets:"
	@echo ""
	@echo "  make          - Build and apply configuration (default)"
	@echo "  make switch   - Build and apply configuration"
	@echo "  make build    - Build only without applying (test mode)"
	@echo "  make update   - Update flake inputs (nixpkgs, home-manager, etc.)"
	@echo "  make check    - Validate flake syntax"
	@echo "  make clean    - Remove build artifacts"
	@echo "  make help     - Show this help message"
	@echo ""
	@echo "Current structure:"
	@echo "  flake.nix â†’ hosts/work.nix"

# Build configuration without applying (test mode)
build:
	@echo "ğŸ”¨ Building configuration for AM-G752H4T49P (test mode)..."
	nix --experimental-features 'nix-command flakes' build .#darwinConfigurations.AM-G752H4T49P.system
	@echo "âœ… Build successful! (not applied)"

# Build and apply configuration
switch:
	@echo "ğŸš€ Building and applying configuration..."
	@nix --experimental-features 'nix-command flakes' build .#darwinConfigurations.AM-G752H4T49P.system
	@echo "âœ… Build successful! Applying..."
	@echo "ğŸ’¡ Note: You may be prompted for your sudo password"
	@sudo darwin-rebuild switch --flake .
	@echo "âœ… Configuration applied successfully!"

# Update flake inputs
update:
	@echo "ğŸ“¦ Updating flake inputs..."
	nix flake update
	@echo "âœ… Flake inputs updated!"
	@echo "ğŸ’¡ Run 'make build' to test the updates."

# Check flake syntax
check:
	@echo "ğŸ” Checking flake syntax..."
	nix flake check
	@echo "âœ… Syntax check passed!"

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf result result-*
	@echo "âœ… Cleaned!"

# Install Nix (if not already installed)
/nix:
	@echo "ğŸ“¥ Installing Nix..."
	curl -L https://nixos.org/nix/install | sh

# Install nix-darwin (if not already installed)
/run/current-system/sw/bin/darwin-rebuild: /nix
	@echo "ğŸ“¥ Installing nix-darwin..."
	/nix/var/nix/profiles/default/bin/nix-build https://github.com/LnL7/nix-darwin/archive/master.tar.gz -A installer
	yes | ./result/bin/darwin-installer

# Install Homebrew (if not already installed)
/opt/homebrew/bin/brew:
	@echo "ğŸ“¥ Installing Homebrew..."
	curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh -o /tmp/brew-install.sh
	NONINTERACTIVE=1 bash /tmp/brew-install.sh

# Bootstrap: Install everything needed for first-time setup
bootstrap: /nix /run/current-system/sw/bin/darwin-rebuild /opt/homebrew/bin/brew
	@echo "âœ… Bootstrap complete! Run 'make build' to test your configuration."
